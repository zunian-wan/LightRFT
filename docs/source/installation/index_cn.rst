.. _installation_cn:

==================================
å®‰è£…æŒ‡å—
==================================

æœ¬æŒ‡å—æä¾›äº† LightRFT çš„å®‰è£…å’Œè®¾ç½®è¯´æ˜ã€‚LightRFT æ˜¯ä¸€ä¸ªè½»é‡åŒ–ã€é«˜æ€§èƒ½çš„å¼ºåŒ–å­¦ä¹ å¾®è°ƒæ¡†æ¶ï¼Œä¸“ä¸ºå¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰å’Œè§†è§‰è¯­è¨€æ¨¡å‹ï¼ˆVLMï¼‰è®¾è®¡ã€‚

ç¯å¢ƒè¦æ±‚
========

åœ¨å®‰è£… LightRFT ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨çš„ç¯å¢ƒæ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š

* Python >= 3.8
* CUDA >= 11.8
* PyTorch >= 2.5.1
* æ”¯æŒ CUDA çš„ GPU

Docker é•œåƒ
===========

TO BE DONE

å®‰è£…æ­¥éª¤
========

æ ‡å‡†å®‰è£…
--------

å…‹éš†å¹¶å®‰è£… LightRFT:

.. code-block:: bash

   # å…‹éš†ä»“åº“
   git clone https://github.com/opendilab/LightRFT.git
   cd LightRFT

   # å®‰è£…ä¾èµ–
   pip install -r requirements.txt

   # å®‰è£… LightRFT
   pip install -e .

ç”Ÿæˆæ–‡æ¡£ï¼ˆå¯é€‰ï¼‰
================

å®‰è£…æ–‡æ¡£ç”Ÿæˆæ‰€éœ€çš„ä¾èµ–ï¼š

.. code-block:: bash

   pip install -r requirements-doc.txt

ç”Ÿæˆ HTML æ–‡æ¡£ï¼š

.. code-block:: bash

   make docs

æ–‡æ¡£å°†ç”Ÿæˆåœ¨ ``docs/build`` ç›®å½•ä¸­ï¼Œæ‰“å¼€ ``index.html`` å³å¯æŸ¥çœ‹ã€‚

å¯åŠ¨å¸¦è‡ªåŠ¨é‡è½½çš„å®æ—¶æ–‡æ¡£æœåŠ¡å™¨ï¼š

.. code-block:: bash

   make docs-live

é¡¹ç›®ç»“æ„
========

LightRFT ç»„ç»‡æˆå‡ ä¸ªå…³é”®æ¨¡å—ï¼š

.. code-block:: text

   LightRFT/
   â”œâ”€â”€ lightrft/                      # æ ¸å¿ƒåº“
   â”‚   â”œâ”€â”€ datasets/                  # æ•°æ®é›†å®ç°
   â”‚   â”‚   â”œâ”€â”€ audio_alpaca.py        # éŸ³é¢‘æ•°æ®é›†
   â”‚   â”‚   â”œâ”€â”€ grm_dataset.py         # é€šç”¨å¥–åŠ±æ¨¡å‹æ•°æ®é›†
   â”‚   â”‚   â”œâ”€â”€ prompts_dataset.py     # æç¤ºæ•°æ®é›†
   â”‚   â”‚   â”œâ”€â”€ prompts_dataset_vl.py  # è§†è§‰è¯­è¨€æç¤ºæ•°æ®é›†
   â”‚   â”‚   â”œâ”€â”€ sft_dataset.py         # SFT æ•°æ®é›†
   â”‚   â”‚   â”œâ”€â”€ sft_dataset_vl.py      # è§†è§‰è¯­è¨€ SFT æ•°æ®é›†
   â”‚   â”‚   â”œâ”€â”€ srm_dataset.py         # å®‰å…¨å¥–åŠ±æ¨¡å‹æ•°æ®é›†
   â”‚   â”‚   â””â”€â”€ utils.py               # æ•°æ®é›†å·¥å…·
   â”‚   â”œâ”€â”€ models/                    # æ¨¡å‹å®šä¹‰
   â”‚   â”‚   â”œâ”€â”€ actor_al.py            # éŸ³é¢‘-è¯­è¨€ Actor æ¨¡å‹
   â”‚   â”‚   â”œâ”€â”€ actor_language.py      # è¯­è¨€ Actor æ¨¡å‹
   â”‚   â”‚   â”œâ”€â”€ actor_vl.py            # è§†è§‰-è¯­è¨€ Actor æ¨¡å‹
   â”‚   â”‚   â”œâ”€â”€ grm_vl.py              # é€šç”¨å¥–åŠ±æ¨¡å‹ (VL)
   â”‚   â”‚   â”œâ”€â”€ srm_al.py              # å®‰å…¨å¥–åŠ±æ¨¡å‹ (AL)
   â”‚   â”‚   â”œâ”€â”€ srm_vl.py              # å®‰å…¨å¥–åŠ±æ¨¡å‹ (VL)
   â”‚   â”‚   â”œâ”€â”€ loss.py                # æŸå¤±å‡½æ•°
   â”‚   â”‚   â”œâ”€â”€ utils.py               # æ¨¡å‹å·¥å…·
   â”‚   â”‚   â””â”€â”€ monkey_patch/          # æ¨¡å‹é€‚é…è¡¥ä¸
   â”‚   â”‚       â”œâ”€â”€ apply.py           # è¡¥ä¸åº”ç”¨
   â”‚   â”‚       â”œâ”€â”€ hf_generate_patch.py  # HuggingFace generate è¡¥ä¸
   â”‚   â”‚       â”œâ”€â”€ llama.py           # LLaMA è¡¥ä¸
   â”‚   â”‚       â””â”€â”€ qwen.py            # Qwen è¡¥ä¸
   â”‚   â”œâ”€â”€ strategy/                  # è®­ç»ƒ&æ¨ç†ç­–ç•¥
   â”‚   â”‚   â”œâ”€â”€ config.py              # ç­–ç•¥é…ç½®
   â”‚   â”‚   â”œâ”€â”€ fake_strategy.py       # æµ‹è¯•ç”¨å‡ç­–ç•¥
   â”‚   â”‚   â”œâ”€â”€ strategy.py            # ä¸»ç­–ç•¥å®ç°
   â”‚   â”‚   â”œâ”€â”€ strategy_base.py       # ç­–ç•¥åŸºç±»
   â”‚   â”‚   â”œâ”€â”€ deepspeed/             # DeepSpeed å®ç°
   â”‚   â”‚   â”‚   â”œâ”€â”€ deepspeed.py       # DeepSpeed ç­–ç•¥
   â”‚   â”‚   â”‚   â””â”€â”€ deepspeed_utils.py # DeepSpeed å·¥å…·
   â”‚   â”‚   â”œâ”€â”€ fsdp/                  # FSDP å®ç°
   â”‚   â”‚   â”‚   â”œâ”€â”€ fsdp_optimizer.py  # FSDP ä¼˜åŒ–å™¨
   â”‚   â”‚   â”‚   â”œâ”€â”€ fsdp_utils.py      # FSDP å·¥å…·
   â”‚   â”‚   â”‚   â””â”€â”€ fsdpv2.py          # FSDP v2 å®ç°
   â”‚   â”‚   â”œâ”€â”€ sglang_utils/          # SGLang å·¥å…·
   â”‚   â”‚   â”‚   â”œâ”€â”€ sglang_engine.py   # SGLang å¼•æ“
   â”‚   â”‚   â”‚   â””â”€â”€ sgl_model_saver.py # SGLang æ¨¡å‹ä¿å­˜å™¨
   â”‚   â”‚   â”œâ”€â”€ vllm_utils/            # vLLM å·¥å…·
   â”‚   â”‚   â”‚   â””â”€â”€ vllm_worker_wrap_no_ray.py  # vLLM worker åŒ…è£…å™¨
   â”‚   â”‚   â””â”€â”€ utils/                 # ç­–ç•¥å·¥å…·
   â”‚   â”‚       â”œâ”€â”€ broadcast_utils.py # å¹¿æ’­å·¥å…·
   â”‚   â”‚       â”œâ”€â”€ ckpt_utils.py      # æ£€æŸ¥ç‚¹å·¥å…·
   â”‚   â”‚       â”œâ”€â”€ data_utils.py      # æ•°æ®å·¥å…·
   â”‚   â”‚       â”œâ”€â”€ distributed_util.py  # åˆ†å¸ƒå¼å·¥å…·
   â”‚   â”‚       â”œâ”€â”€ optimizer_utils.py # ä¼˜åŒ–å™¨å·¥å…·
   â”‚   â”‚       â”œâ”€â”€ parallel_utils.py  # å¹¶è¡Œå·¥å…·
   â”‚   â”‚       â””â”€â”€ statistic.py       # ç»Ÿè®¡å·¥å…·
   â”‚   â”œâ”€â”€ trainer/                   # Trainer å®ç°
   â”‚   â”‚   â”œâ”€â”€ experience_maker.py    # ç»éªŒç”Ÿæˆå™¨
   â”‚   â”‚   â”œâ”€â”€ experience_maker_vl.py # VLM ç»éªŒç”Ÿæˆå™¨
   â”‚   â”‚   â”œâ”€â”€ fast_exp_maker.py      # å¿«é€Ÿç»éªŒç”Ÿæˆå™¨
   â”‚   â”‚   â”œâ”€â”€ grm_trainer_vl.py      # é€šç”¨å¥–åŠ±æ¨¡å‹è®­ç»ƒå™¨ (VL)
   â”‚   â”‚   â”œâ”€â”€ kl_controller.py       # KL æ•£åº¦æ§åˆ¶å™¨
   â”‚   â”‚   â”œâ”€â”€ ppo_trainer.py         # PPO è®­ç»ƒå™¨
   â”‚   â”‚   â”œâ”€â”€ ppo_trainer_vl.py      # è§†è§‰-è¯­è¨€ PPO è®­ç»ƒå™¨
   â”‚   â”‚   â”œâ”€â”€ replay_buffer.py       # å›æ”¾ç¼“å†²åŒº
   â”‚   â”‚   â”œâ”€â”€ replay_buffer_utils.py # å›æ”¾ç¼“å†²åŒºå·¥å…·
   â”‚   â”‚   â”œâ”€â”€ replay_buffer_vl.py    # è§†è§‰-è¯­è¨€å›æ”¾ç¼“å†²åŒº
   â”‚   â”‚   â”œâ”€â”€ spmd_ppo_trainer.py    # SPMD PPO è®­ç»ƒå™¨
   â”‚   â”‚   â”œâ”€â”€ srm_trainer_al.py      # å®‰å…¨å¥–åŠ±æ¨¡å‹è®­ç»ƒå™¨ (AL)
   â”‚   â”‚   â”œâ”€â”€ srm_trainer_vl.py      # å®‰å…¨å¥–åŠ±æ¨¡å‹è®­ç»ƒå™¨ (VL)
   â”‚   â”‚   â””â”€â”€ utils.py               # è®­ç»ƒå™¨å·¥å…·
   â”‚   â””â”€â”€ utils/                     # å·¥å…·å‡½æ•°
   â”‚       â”œâ”€â”€ cli_args.py            # CLI å‚æ•°è§£æ
   â”‚       â”œâ”€â”€ distributed_sampler.py # åˆ†å¸ƒå¼é‡‡æ ·å™¨
   â”‚       â”œâ”€â”€ logging_utils.py       # æ—¥å¿—å·¥å…·
   â”‚       â”œâ”€â”€ processor.py           # æ•°æ®å¤„ç†å™¨
   â”‚       â”œâ”€â”€ remote_rm_utils.py     # è¿œç¨‹å¥–åŠ±æ¨¡å‹å·¥å…·
   â”‚       â”œâ”€â”€ timer.py               # è®¡æ—¶å™¨å·¥å…·
   â”‚       â”œâ”€â”€ trajectory_saver.py    # è½¨è¿¹ä¿å­˜å·¥å…·
   â”‚       â””â”€â”€ utils.py               # é€šç”¨å·¥å…·
   â”‚
   â”œâ”€â”€ examples/                      # ä½¿ç”¨ç¤ºä¾‹
   â”‚   â”œâ”€â”€ chat/                      # å¯¹è¯æ¨¡å‹è®­ç»ƒç¤ºä¾‹
   â”‚   â”œâ”€â”€ grm_training/              # é€šç”¨å¥–åŠ±æ¨¡å‹è®­ç»ƒç¤ºä¾‹
   â”‚   â”œâ”€â”€ gsm8k_geo3k/               # GSM8K/Geo3K æ•°å­¦æ¨ç†ç¤ºä¾‹
   â”‚   â”‚   â”œâ”€â”€ data_preprocess/       # æ•°æ®é¢„å¤„ç†è„šæœ¬
   â”‚   â”‚   â”œâ”€â”€ train_colocate.py      # ååŒå®šä½è®­ç»ƒè„šæœ¬
   â”‚   â”‚   â”œâ”€â”€ reward_models_utils.py # å¥–åŠ±æ¨¡å‹å·¥å…·
   â”‚   â”‚   â”œâ”€â”€ run_grpo_gsm8k_qwen2.5_0.5b.sh    # GSM8K è®­ç»ƒè„šæœ¬
   â”‚   â”‚   â””â”€â”€ run_grpo_geo3k_qwen2.5_vl_7b.sh   # Geo3K VLM è®­ç»ƒè„šæœ¬
   â”‚   â”œâ”€â”€ safework_t1/               # å®‰å…¨å¯ä¿¡å·¥ä½œç¤ºä¾‹
   â”‚   â””â”€â”€ srm_training/              # å®‰å…¨å¥–åŠ±æ¨¡å‹è®­ç»ƒç¤ºä¾‹
   â”‚
   â”œâ”€â”€ docs/                          # ğŸ“š Sphinx æ–‡æ¡£
   â”‚   â””â”€â”€ source/
   â”‚       â”œâ”€â”€ installation/          # å®‰è£…æŒ‡å—
   â”‚       â”œâ”€â”€ quick_start/           # å¿«é€Ÿå¼€å§‹ & ç”¨æˆ·æŒ‡å—
   â”‚       â”œâ”€â”€ best_practice/         # æœ€ä½³å®è·µ & èµ„æº
   â”‚       â””â”€â”€ api_doc/               # API æ–‡æ¡£
   â”‚           â”œâ”€â”€ datasets/          # æ•°æ®é›† API
   â”‚           â”œâ”€â”€ models/            # æ¨¡å‹ API
   â”‚           â”œâ”€â”€ strategy/          # ç­–ç•¥ API
   â”‚           â”œâ”€â”€ trainer/           # è®­ç»ƒå™¨ API
   â”‚           â””â”€â”€ utils/             # å·¥å…· API
   â”‚
   â”œâ”€â”€ assets/                        # èµ„æºæ–‡ä»¶
   â”‚   â””â”€â”€ logo.png                   # é¡¹ç›®Logo
   â”‚
   â”œâ”€â”€ results/                       # è®­ç»ƒç»“æœ
   â”œâ”€â”€ rft_logs/                      # è®­ç»ƒæ—¥å¿—
   â”œâ”€â”€ requirements.txt               # Python ä¾èµ–
   â”œâ”€â”€ requirements-dev.txt           # å¼€å‘ä¾èµ–
   â”œâ”€â”€ requirements-doc.txt           # æ–‡æ¡£ä¾èµ–
   â”œâ”€â”€ setup.py                       # åŒ…è®¾ç½®
   â””â”€â”€ README.md                      # é¡¹ç›®æ–‡æ¡£

å…³é”®ç›®å½•è¯´æ˜
------------

* **lightrft/**ï¼šLightRFT æ ¸å¿ƒåº“ï¼ŒåŒ…å«äº”ä¸ªä¸»è¦æ¨¡å—ï¼š

  * ``datasets/``ï¼šæ•°æ®é›†å®ç°ï¼Œæ”¯æŒæç¤ºã€SFTã€å¥–åŠ±å»ºæ¨¡ï¼ˆæ–‡æœ¬ã€è§†è§‰-è¯­è¨€ã€éŸ³é¢‘-è¯­è¨€ï¼‰
  * ``models/``ï¼šActor æ¨¡å‹ï¼ˆè¯­è¨€ã€è§†è§‰-è¯­è¨€ã€éŸ³é¢‘-è¯­è¨€ï¼‰ã€å¥–åŠ±æ¨¡å‹å’ŒæŸå¤±å‡½æ•°
  * ``strategy/``ï¼šè®­ç»ƒç­–ç•¥ï¼ŒåŒ…æ‹¬ FSDPã€DeepSpeedã€vLLM/SGLang é›†æˆ
  * ``trainer/``ï¼šè®­ç»ƒå™¨å®ç°ï¼ŒåŒ…æ‹¬ PPOã€ç»éªŒç”Ÿæˆå’Œå›æ”¾ç¼“å†²åŒº
  * ``utils/``ï¼šå·¥å…·å‡½æ•°ï¼Œç”¨äº CLIã€æ—¥å¿—ã€åˆ†å¸ƒå¼è®­ç»ƒå’Œè½¨è¿¹ä¿å­˜

* **examples/**ï¼šå®Œæ•´çš„è®­ç»ƒç¤ºä¾‹å’Œè„šæœ¬

  * ``gsm8k_geo3k/``ï¼šGSM8K å’Œ Geo3K æ•°å­¦æ¨ç†è®­ç»ƒç¤ºä¾‹
  * ``grm_training/``ï¼šé€šç”¨å¥–åŠ±æ¨¡å‹è®­ç»ƒç¤ºä¾‹
  * ``srm_training/``ï¼šå®‰å…¨å¥–åŠ±æ¨¡å‹è®­ç»ƒç¤ºä¾‹
  * ``chat/``ï¼šå¯¹è¯æ¨¡å‹è®­ç»ƒç¤ºä¾‹
  * ``safework_t1/``ï¼šå®‰å…¨å¯ä¿¡å·¥ä½œç¤ºä¾‹

* **docs/**ï¼šSphinx æ–‡æ¡£ï¼ŒåŒ…å«å®Œæ•´çš„ç”¨æˆ·æŒ‡å—å’Œ API æ–‡æ¡£

éªŒè¯å®‰è£…
========

éªŒè¯å®‰è£…æ˜¯å¦æˆåŠŸï¼Œè¿è¡Œç®€å•æµ‹è¯•ï¼š

.. code-block:: bash

   python -c "import lightrft; print(lightrft)"

å¦‚æœæ²¡æœ‰å¯¼å…¥é”™è¯¯ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°æ¨¡å—è·¯å¾„ã€‚

å¿«é€Ÿå¼€å§‹ç¤ºä¾‹
============

å®‰è£…å®Œæˆåï¼Œå°è¯•ä¸€ä¸ªåŸºç¡€çš„ GRPO è®­ç»ƒç¤ºä¾‹ï¼š

.. code-block:: bash

   # å•èŠ‚ç‚¹ 8 GPU è®­ç»ƒç¤ºä¾‹
   cd /path/to/LightRFT

   # è¿è¡Œ GRPO è®­ç»ƒï¼ˆGSM8K æ•°å­¦æ¨ç†ä»»åŠ¡ï¼‰
   bash examples/gsm8k_geo3k/run_grpo_gsm8k_qwen2.5_0.5b.sh

   # æˆ–è€…è¿è¡Œ Geo3K å‡ ä½•é—®é¢˜è®­ç»ƒï¼ˆVLM å¤šæ¨¡æ€ï¼‰
   bash examples/gsm8k_geo3k/run_grpo_geo3k_qwen2.5_vl_7b.sh

æ•…éšœæ’é™¤
========

å¸¸è§é—®é¢˜
--------

**é—®é¢˜**ï¼šCUDA é”™è¯¯æˆ–ç‰ˆæœ¬ä¸åŒ¹é…

* **è§£å†³æ–¹æ¡ˆ**ï¼šç¡®ä¿ CUDA é©±åŠ¨å’Œå·¥å…·åŒ…ç‰ˆæœ¬ä¸ PyTorch å®‰è£…åŒ¹é…ã€‚ä½¿ç”¨ ``nvcc --version`` å’Œ ``python -c "import torch; print(torch.version.cuda)"`` æ£€æŸ¥

**é—®é¢˜**ï¼šè®­ç»ƒæ—¶å†…å­˜ä¸è¶³é”™è¯¯

* **è§£å†³æ–¹æ¡ˆ**ï¼š

  * å‡å° ``micro_train_batch_size`` æˆ– ``micro_rollout_batch_size``
  * å¯ç”¨æ¢¯åº¦æ£€æŸ¥ç‚¹ï¼š``--gradient_checkpointing``
  * ä½¿ç”¨ FSDP + CPU å¸è½½ï¼š``--fsdp --fsdp_cpu_offload``
  * è°ƒæ•´å¼•æ“å†…å­˜åˆ©ç”¨ç‡ï¼š``--engine_mem_util 0.4``

**é—®é¢˜**ï¼šè¯„æµ‹ä¾èµ–å®‰è£…ç¼“æ…¢

* **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨é•œåƒæˆ–ä»£ç†è¿›è¡Œ pip å®‰è£…ï¼š

  .. code-block:: bash

     pip install -i https://pypi.tuna.tsinghua.edu.cn/simple <package>

è·å–æ›´å¤šæ”¯æŒ
------------

å¦‚æœé‡åˆ°æ­¤å¤„æœªæ¶µç›–çš„é—®é¢˜ï¼š

* æŸ¥çœ‹é¡¹ç›®çš„ `GitHub Issues <https://github.com/opendilab/LightRFT/issues>`_
* æŸ¥é˜… :doc:`../best_practice/strategy_usage` äº†è§£è®­ç»ƒé…ç½®
* å‚è€ƒ ``examples/`` ç›®å½•ä¸­çš„ç¤ºä¾‹è„šæœ¬

åç»­æ­¥éª¤
========

å®‰è£…æˆåŠŸåï¼š

1. æŸ¥é˜… :doc:`../quick_start` æŒ‡å—äº†è§£åŸºæœ¬ä½¿ç”¨æ–¹æ³•
2. æ¢ç´¢ :doc:`../best_practice/strategy_usage` äº†è§£åˆ†å¸ƒå¼è®­ç»ƒç­–ç•¥
3. æŸ¥çœ‹ ``examples/`` ç›®å½•ä¸­çš„å®Œæ•´è®­ç»ƒç¤ºä¾‹
4. é˜…è¯»ç®—æ³•æ–‡æ¡£äº†è§£å…·ä½“å®ç°ç»†èŠ‚

ç›¸å…³æ–‡æ¡£
========

* :doc:`../quick_start` - å¿«é€Ÿå¼€å§‹æŒ‡å—
* :doc:`../best_practice/strategy_usage` - Strategy ä½¿ç”¨æŒ‡å—
* :doc:`../api/index` - API å‚è€ƒ
